<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>
<script src="matrix.js"></script>
<script>
    const tol = 1e-3;

    function isEqualWithTol( a, b ) {
        a = a.tolist ? a.arraySync() : a;
        b = b.tolist ? b.arraySync() : b;
        return a.reduce( ( acc1, row, i ) => {
            return acc1 && row.reduce( ( acc2, x, j ) => {
                const diff = Math.abs( x - b[ i ][ j ] );
                return acc2 && diff < tol;
            }, true );
        }, true );
    }

    matMul: {
        const v1 = [ [ 1, 2 ], [ 3, 4 ] ];
        const v2 = [ [ 5, 6 ], [ 7, 8 ] ];
        const x = new Matrix( v1 );
        const y = new Matrix( v2 );
        const z = x[ 'matMul' ]( y );
        z.forward();
        z.backward();
        const f = ( x, y ) => x[ 'matMul' ]( y );
        const mgData = z.data;
        const mgGradX = x.grad;
        const mgGradY = y.grad;
        const tfData = f( tf.tensor2d( v1 ), tf.tensor2d( v2 ) ).arraySync();
        const grads = tf.grads( f )( [ tf.tensor2d( v1 ), tf.tensor2d( v2 ) ] );
        const tfGradX = grads[ 0 ].arraySync();
        const tfGradY = grads[ 1 ].arraySync();
        z.color = isEqualWithTol( mgData, tfData ) ? 'green' : 'red';
        x.color = isEqualWithTol( mgGradX, tfGradX ) ? 'green' : 'red';
        y.color = isEqualWithTol( mgGradY, tfGradY ) ? 'green' : 'red';
        console.assert( isEqualWithTol( mgData, tfData ) );
        console.assert( isEqualWithTol( mgGradX, tfGradX ) );
        console.assert( isEqualWithTol( mgGradY, tfGradY ) );
        console.log( 'matMul' );
    }

    softmaxCrossEntropy: {
        const v1 = [ [ 1, 2 ], [ 3, 4 ] ];
        const v2 = [ [ 0, 1 ], [ 1, 0 ] ];
        const x = new Matrix( v1 );
        const z = x[ 'softmaxCrossEntropy' ]( v2 );
        z.forward();
        z.backward();
        const f = ( x ) => tf.losses.softmaxCrossEntropy( v2, x );
        const mgData = z.data;
        const mgGradX = x.grad;
        const tfData = f( tf.tensor2d( v1 ) ).arraySync();
        const tfGradX = tf.grad( f )( tf.tensor2d( v1 ) ).arraySync();
        z.color = Math.abs( mgData - tfData ) < tol ? 'green' : 'red';
        x.color = isEqualWithTol( mgGradX, tfGradX ) ? 'green' : 'red';
        console.assert( Math.abs( mgData - tfData ) < tol );
        console.log( mgGradX, tfGradX )
        console.assert( isEqualWithTol( mgGradX, tfGradX ) );
    }
</script>